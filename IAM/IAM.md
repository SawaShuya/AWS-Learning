# IAM
## 概要

<img src="img/IAM_icon.png" width="50">

AWSにおける権限管理サービス。アカウントを安全に運用するために利用。

| 重要単語 | 意味 | 
|:-----------|:------------|
| ルートアカウント| すべての権限を持ったアカウント <br>アカウント登録時の初期アカウント  |
|ユーザー|ルートアカウント内に生成できるユーザー <br> 一つのアカウントで複数のユーザーを管理できる|
|ユーザーグループ|同じ権限を付与するためのグループ <br>ユーザーのみを含む|
|ロール|AWSのサービス(EC2やLamdbaがよく使われる)から、<br>他のサービスへのアクセス権限を定めたもの|
|ポリシー|権限についての記述 <br> JSON形式で記述される |
|フェデレーテッドユーザー | 別システムでのユーザー。外部のユーザを連合させて、IAMユーザーとして扱うことができる。|
| プリンシパル | ユーザーおよびロール。ポリシーを付与できる。|


## ポリシー設計
権限をJSON形式で記述したもの。ユーザー、ユーザーグループ、ロールにそれぞれ割り当てることができ、それらが割りつけられた対象はポリシーに従って権限が付与される。

### 第一階層 (Consist of)
| key | 記述内容 | 
|:-----|:------|
| Version | ポリシーのバージョン |
| Id | 特定のポリシー (任意) |
| Statement | 1つ以上のステートメント (必須) |

### Statement内の第二階層  (Statement consist of)

| key | 記述内容 | 
|:-----|:------|
| Sid | satatement内のID番号 |
| Effect | 許可するか拒否するか |
| Principal | このポリシーを割り当てるアカウント、ユーザー、ロール |
| Action | 許可(拒否)するアクションのリスト |
| Resorce | アクションをを適用するリソース|
| Condition | このポリシー自体の状態。(任意) |
 
## ポリシーの種類
- アイデンティティーポリシー
  - インラインポリシー
  - 管理ポリシー
    - AWS管理ポリシー
    - カスタマー管理ポリシー
- リソースベースポリシー

## ユーザー・ユーザーグループ
- ユーザー自体にインラインポリシーを付与することができる
- ユーザーグループにポリシーを付与し、それをユーザーに割り当てることができる
- ユーザーは複数のユーザーグループに属すことができる(属さなくてもよい)


## ロール
- AWSのサービスに対して付与
- そのサービスからAWSの他のサービスに対しての権限
- EC2、Lamdbaによく使う

## パスワード設定
- ユーザー対してパスワードの制約条件を設定できる

## 多段階認証 (Malti Factor Authentication)
- 多段階認証を導入することによりセキュリティ向上
- 特にルートアカウントの設定をおすすめ
- 2種類の方法
  - Virtual MFA device
    - スマホアプリケーションと連携。ワンタイムパスコード。
  
  - Universal 2nd Factor (U2F) Security Key
    - 専用デバイス。挿入するのみでMFA完了のものや、ワンタイムを表示するためのデバイスがある。
     
## AWSへのアクセス方法
主要3つの方法

| ケース | 認証方法 | 
|:-----|:------|
| AWSマネジメントコンソール | メールアドレス + パスワード|
| AWS Command Line Interface (CLI) <br> AWS Software Developer Kit (SDK) | アクセスキー <br> (Access Key ID + Secret Access Key)|
|  | AWS Security Token Service でアクセスキーを生成 |


アクセスキーはユーザーごとに設定可能。
漏らさないように！！

## 認可の流れ
次の順番に評価され、基本的に許可されていた場合に後続の評価へと移る。ただし、リソースベースドポリシー評価でアクションが許可されていた場合は、その時点でアクセスが可能(後続の評価を無視)

1. すべての適用ポリシーを評価
2. AWS Organization SCP
3. リソースベースドポリシー
4. パーミッションバウンダリー (ユーザー、ロールに追加で管理ポリシーを設定)
5. セッションポリシー(STSで一時的な認証情報を使用)
6. アイデンティティベースドポリシー

基本的にそれぞれの評価で明示的に拒否されていた場合、アクセスが暗黙的に拒否される。
「すべての適用ポリシー評価」のみ明示的に拒否。

## 権限の委任

### ロール引き受け (AssumeRole)
STSを使った一時的な認証。ロールを作成し、

- 信頼されたエンティティ(対象となるユーザー。リソースベースのポリシーを付与することで設定。このポリシーを信頼ポリシーと呼ぶ。)
- アクセスポリシー

を設定。

信頼ポリシーでは、プリンシパルに信頼されたエンティティを指定するとともに、アクションとして"sts:AssumeRole"を設定し、許可する。

アクセスポリシーではリソース(S3など)へのアクセス権限を付与。

信頼されたエンティティが、STSへAsuumeRole APIを実行することで認証情報一時的にリソースへのアクセスが可能になる。

<br>

### EC2インスタンスのIAMロール
[参考](https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html)

EC2から別のリソースへのアクセスをロールで管理。

ロールを作成し付与をすることで、インスタンスのメタデータから一時的な認証を取得可能。そしてアクセスが可能になる。

### クロスアカウントロール
別のアカウントのリソースにアクセスしたいときに、クロスアカウントロールを使用。

別アカウントの方でAssumeRoleを設定すればOK。
設定するプリンシパルを自分のアカウントのユーザーorリソースを設定。

<br>

### 外部IDフェデレーションユーザのロール引き受け

#### 登場語句
| 単語 | 概要 | 
|:-----|:------|
| [SAML (Security Assertion Markup Language)](https://www.cybernet.co.jp/onelogin/function/saml.html#:~:text=SAML%E3%81%A8%E3%81%AF%E3%80%81Security%20Assertion,2.0%E3%81%A8%E3%81%AA%E3%81%A3%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82) | OASIS (Organization for the Advancement of Structured Information Standards)によって策定された異なるインターネットドメイン間でユーザー認証を行うための XML をベースにした標準規格。SAML対応しているサービスに1回ログインするだけで、複数のサービスが利用可能になる。 |
|IdP (Identity Provider)| SAMLにおける認証情報を提供する側|
|SP (Service Provider) | 認証情報を利用する側。(一般的にはアプリケーション)|
|フェデレーション | 一度認証を通れば、その認証情報を使って、許可されているすべてのサービスを使えるようにする仕組み |
|[SAMLアサーション](https://www.oracle.com/jp/security/cloud-security/what-is-saml/)|IdPがユーザー認可ステータスを含むSPに送信するXMLドキュメント|
| [OIDC (Open ID Connect)](https://qiita.com/TakahikoKawasaki/items/498ca08bbfcc341691fe#%E3%81%93%E3%81%AE%E3%81%82%E3%81%A8%E3%81%AE%E8%AA%AC%E6%98%8E%E6%89%8B%E9%A0%86) | シンプルな ID プロトコルであり、OAuth 2.0 プロトコルを使用して構築されたオープン・スタンダード。IDトークンを発行する仕組み |
| IDストア | IDの保管場所 |

<br>

#### SAML2.0に準拠したIDプロバイダのフェデレーション

1. アプリから企業内ネットワーク内にあるIdPに認証要求
2. SAMLアサーションの返答
3. AssumeRoleWithSAMLを呼び出し、ロールをを引き受け一時認証情報を取得
4. AWSリソースへのアクセス


<br>

#### Amazon Cognitoを使用したモバイル・ウェブアプリケーションやソーシャルメディア、OIDCに準拠したIDプロバイダのフェデレーション

#### SAMLやOIDCと互換性のないIDストアを中継するカスタムIDブローカーアプリケーションのフェデレーション




## IAMセキュリティーツール

| ツール | 概要 | 
|:-----|:------|
| IAM Credential Report | アカウント内のユーザーとそれぞれの権限情報を確認できるレポート |
| IAM Access Advisor | ユーザーがなんの権限を持っていて、それぞれのサービスに最後いつアクセスしたのか確認できるレポート |

## IAM ベストプラクティス
- アカウントセットアップ以外ではルートアカウントを使用しない
- 1人に対して1ユーザーを割り当てる
- ユーザーにはユーザーグループで権限を与える
- 強力なパスワードポリシーを設定すること
- MFAを使用すること
- AWSのサービスにはロールを付与すること
- CLIやSDKにはアクセスキーを使用すること
- ユーザーの権限情報はIAM Credential ReportやIAM Access Advisorで監査すること
- 絶対にIAM ユーザーとアクセスキーをシェアしないこと
 
## その他留意事項